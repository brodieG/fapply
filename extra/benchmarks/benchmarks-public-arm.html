<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Benchmarks for r2c and Alternatives</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Benchmarks for r2c and Alternatives</h1>


<div id="TOC">
<ul>
<li><a href="#prelude" id="toc-prelude">Prelude</a></li>
<li><a href="#group-benchmarks" id="toc-group-benchmarks">Group
Benchmarks</a>
<ul>
<li><a href="#group-data" id="toc-group-data">Group Data</a></li>
<li><a href="#group-slope" id="toc-group-slope">Group Slope</a>
<ul>
<li><a href="#r2c-baseline" id="toc-r2c-baseline">r2c Baseline</a></li>
<li><a href="#base-r-and-fastr" id="toc-base-r-and-fastr">Base R and
FastR</a></li>
<li><a href="#data.table" id="toc-data.table">data.table</a></li>
<li><a href="#collapse" id="toc-collapse">collapse</a></li>
</ul></li>
<li><a href="#group-sum" id="toc-group-sum">Group Sum</a>
<ul>
<li><a href="#r2c-baseline-1" id="toc-r2c-baseline-1">r2c
baseline</a></li>
<li><a href="#base-r-and-fastr-1" id="toc-base-r-and-fastr-1">Base R and
FastR</a></li>
<li><a href="#data.table-1" id="toc-data.table-1">data.table</a></li>
<li><a href="#collapse-1" id="toc-collapse-1">collapse</a></li>
</ul></li>
<li><a href="#bigger-groups" id="toc-bigger-groups">Bigger
Groups</a></li>
</ul></li>
<li><a href="#window-benchmarks" id="toc-window-benchmarks">Window
Benchmarks</a>
<ul>
<li><a href="#window-data" id="toc-window-data">Window Data</a></li>
<li><a href="#window-slope" id="toc-window-slope">Window Slope</a>
<ul>
<li><a href="#baselines" id="toc-baselines">Baselines</a></li>
<li><a href="#base-and-fastr" id="toc-base-and-fastr">Base and
FastR</a></li>
<li><a href="#roll" id="toc-roll">Roll</a></li>
<li><a href="#data.table-2" id="toc-data.table-2">data.table</a></li>
<li><a href="#zoo" id="toc-zoo">Zoo</a></li>
<li><a href="#slider" id="toc-slider">Slider</a></li>
</ul></li>
<li><a href="#window-sum" id="toc-window-sum">Window Sum</a>
<ul>
<li><a href="#r2c-baseline-2" id="toc-r2c-baseline-2">r2c
Baseline</a></li>
<li><a href="#base-and-fastr-1" id="toc-base-and-fastr-1">Base and
FastR</a></li>
<li><a href="#roll-1" id="toc-roll-1">Roll</a></li>
<li><a href="#zoo-1" id="toc-zoo-1">Zoo</a></li>
<li><a href="#data.table-3" id="toc-data.table-3">data.table</a></li>
<li><a href="#rcpproll" id="toc-rcpproll">RcppRoll</a></li>
<li><a href="#slider-1" id="toc-slider-1">Slider</a></li>
</ul></li>
</ul></li>
<li><a href="#session-info" id="toc-session-info">Session Info</a></li>
</ul>
</div>

<div id="prelude" class="section level1">
<h1>Prelude</h1>
<p><code>system.time</code> is modified here to run 11 times after an
initial gc, and display mean run time.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>system.time <span class="ot">&lt;-</span> sys.time <span class="ot">&lt;-</span> <span class="cf">function</span>(exp, <span class="at">reps=</span><span class="dv">11</span>) {</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, reps, <span class="dv">5</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  time.call <span class="ot">&lt;-</span> <span class="fu">quote</span>(base<span class="sc">::</span><span class="fu">system.time</span>({<span class="cn">NULL</span>}))</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  time.call[[<span class="dv">2</span>]][[<span class="dv">2</span>]] <span class="ot">&lt;-</span> <span class="fu">substitute</span>(exp)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gc</span>()</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_len</span>(reps)) {</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    res[i,] <span class="ot">&lt;-</span> <span class="fu">eval</span>(time.call, <span class="fu">parent.frame</span>())</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">structure</span>(res, <span class="at">class=</span><span class="st">&#39;proc_time2&#39;</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>print.proc_time2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x, ...) {</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">structure</span>(</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>      <span class="co"># x[order(x[,3]),][ceiling(nrow(x)/2),],</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">round</span>(<span class="fu">colMeans</span>(x), <span class="dv">3</span>),</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">names=</span><span class="fu">c</span>(<span class="st">&quot;user.self&quot;</span>, <span class="st">&quot;sys.self&quot;</span>, <span class="st">&quot;elapsed&quot;</span>, <span class="st">&quot;user.child&quot;</span>, <span class="st">&quot;sys.child&quot;</span>),</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">class=</span><span class="st">&#39;proc_time&#39;</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>) ) }</span></code></pre></div>
<p>On an Intel(R) Core(TM) m5-6Y54 CPU @ 1.20GHz (early 2016 Macbook),
and -O2 optimization level. Different systems / compilers / settings may
produce different results.</p>
</div>
<div id="group-benchmarks" class="section level1">
<h1>Group Benchmarks</h1>
<p>We compare <code>{r2c}</code> to various alternatives using
pre-sorted and pre-grouped (or split) data set as previously.
Pre-sorting and pre-grouping allows us to focus timings on the statistic
computation<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>.</p>
<div id="group-data" class="section level2">
<h2>Group Data</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fl">1e7</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>gn <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>ng <span class="ot">&lt;-</span> n<span class="sc">/</span>gn</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">runif</span>(n) <span class="sc">*</span> <span class="fu">runif</span>(n)  <span class="co"># full 64 bit precision randomness</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">runif</span>(n) <span class="sc">*</span> <span class="fu">runif</span>(n)  <span class="co"># for later</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># pre-sorted groups</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(<span class="fu">sample</span>(<span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="fu">rep</span>(<span class="cn">FALSE</span>, gn <span class="sc">-</span> <span class="dv">1</span>)), n, <span class="at">replace=</span><span class="cn">TRUE</span>))</span></code></pre></div>
</div>
<div id="group-slope" class="section level2">
<h2>Group Slope</h2>
<p>For apples to apples comparison, we use <code>mean1</code> instead of
<code>mean</code> as <code>mean</code> uses a two-pass calculation for
precision, but <code>{collapse}</code> uses a single pass mean.</p>
<!-- we're slightly lying here because we can't redefine `mean1` without r2c
complaining about it, but it's a white lie -->
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>mean1 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">sum</span>(x) <span class="sc">/</span> <span class="fu">length</span>(x)</span></code></pre></div>
<div id="r2c-baseline" class="section level3">
<h3>r2c Baseline</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>g.r2c <span class="ot">&lt;-</span> <span class="fu">process_groups</span>(g, <span class="at">sorted=</span><span class="cn">TRUE</span>)  <span class="co"># pre-grouping</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>r2c_slope1 <span class="ot">&lt;-</span> <span class="fu">r2cq</span>(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>((x <span class="sc">-</span> <span class="fu">mean1</span>(x)) <span class="sc">*</span> (y <span class="sc">-</span> <span class="fu">mean1</span>(y))) <span class="sc">/</span> <span class="fu">sum</span>((x <span class="sc">-</span> <span class="fu">mean1</span>(x))<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(slope.r2c <span class="ot">&lt;-</span> <span class="fu">group_exec</span>(r2c_slope1, g.r2c, <span class="fu">list</span>(x, y)))</span></code></pre></div>
<pre><code>##    user  system elapsed 
##    0.06    0.00    0.06</code></pre>
</div>
<div id="base-r-and-fastr" class="section level3">
<h3>Base R and FastR</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>x.split <span class="ot">&lt;-</span> <span class="fu">split</span>(x, g)    <span class="co"># pre-group</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>y.split <span class="ot">&lt;-</span> <span class="fu">split</span>(y, g)    <span class="co"># pre-group</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>slope <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y) <span class="fu">sum</span>((x <span class="sc">-</span> <span class="fu">mean1</span>(x)) <span class="sc">*</span> (y <span class="sc">-</span> <span class="fu">mean1</span>(y))) <span class="sc">/</span> <span class="fu">sum</span>((x <span class="sc">-</span> <span class="fu">mean1</span>(x)) <span class="sc">^</span> <span class="dv">2</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(slope.base <span class="ot">&lt;-</span> <span class="fu">mapply</span>(slope, x.split, y.split))</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   2.591   0.033   2.624</code></pre>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(slope.r2c, slope.base)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p><code>{FastR}</code> uses the same code, but needs to be run under
the <code>{FastR}</code> implementation of R.</p>
</div>
<div id="data.table" class="section level3">
<h3>data.table</h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">data.table</span>(x, y, g)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>data.table<span class="sc">::</span><span class="fu">setkey</span>(dt, g)  <span class="co"># pre-sorting</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>mean <span class="ot">&lt;-</span> mean1  <span class="co"># so name change alone doesn&#39;t break Gforce</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  slope.dt <span class="ot">&lt;-</span> dt[,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>((x <span class="sc">-</span> <span class="fu">mean</span>(x)) <span class="sc">*</span> (y <span class="sc">-</span> <span class="fu">mean</span>(y))) <span class="sc">/</span> <span class="fu">sum</span>((x <span class="sc">-</span> <span class="fu">mean</span>(x)) <span class="sc">^</span> <span class="dv">2</span>), <span class="at">keyby=</span>g</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  ][[<span class="st">&quot;V1&quot;</span>]]</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   2.270   0.028   2.299</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(slope.dt, <span class="fu">unname</span>(slope.base))</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(slope.dt, <span class="fu">unname</span>(slope.base))</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(mean)</span></code></pre></div>
<p>In this case using <code>mean1</code> alone would break Gforce, but
it’s moot as the complex expression would too. This is not entirely fair
to <code>{data.table}</code> as it does not pre-group like
<code>{collapse}</code>/<code>{r2c}</code></p>
</div>
<div id="collapse" class="section level3">
<h3>collapse</h3>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(collapse)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>g.clp <span class="ot">&lt;-</span> <span class="fu">GRP</span>(g)   <span class="co"># pre-sort/group</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>fmean2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x, cg) <span class="fu">fmean</span>(x, cg, <span class="at">na.rm=</span><span class="cn">FALSE</span>, <span class="at">TRA=</span><span class="st">&quot;replace_fill&quot;</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  slope.clp <span class="ot">&lt;-</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fsum</span>((x <span class="sc">-</span> <span class="fu">fmean2</span>(x, g.clp)) <span class="sc">*</span> (y <span class="sc">-</span> <span class="fu">fmean2</span>(y, g.clp)), g.clp, <span class="at">na.rm=</span><span class="cn">FALSE</span>) <span class="sc">/</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fsum</span>((x <span class="sc">-</span> <span class="fu">fmean2</span>(x, g.clp))<span class="sc">^</span><span class="dv">2</span>, g.clp, <span class="at">na.rm=</span><span class="cn">FALSE</span>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.193   0.007   0.200</code></pre>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(slope.clp, slope.base)</span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(slope.clp, slope.base)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>Alternatively and with similar performance</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  slope.clp<span class="fl">.2</span> <span class="ot">&lt;-</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fsum</span>(<span class="fu">fwithin</span>(x, g.clp, <span class="at">na.rm=</span><span class="cn">FALSE</span>) <span class="sc">*</span> <span class="fu">fwithin</span>(y, g.clp, <span class="at">na.rm=</span><span class="cn">FALSE</span>), g.clp, <span class="at">na.rm=</span><span class="cn">FALSE</span>) <span class="sc">/</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fsum</span>(<span class="fu">fwithin</span>(x, g.clp, <span class="at">na.rm=</span><span class="cn">FALSE</span>)<span class="sc">^</span><span class="dv">2</span>, g.clp, <span class="at">na.rm=</span><span class="cn">FALSE</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.185   0.008   0.193</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(slope.clp<span class="fl">.2</span>, slope.clp)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>Thanks to Sebastian Krantz for pointing out the
<code>TRA=&quot;replace_fill&quot;</code> functionality, and for the alternate
formulations.</p>
<p>Or in more <code>{collapse}</code> semantic form (and a little faster
because we allow re-use of <code>x - mean(x)</code>, which we don’t use
for comparison since that’s no longer apples to apples):</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>slope.clp<span class="fl">.3</span> <span class="ot">&lt;-</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(x, y, g) <span class="sc">|&gt;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">fgroup_by</span>(g) <span class="sc">|&gt;</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">fmutate</span>(<span class="at">x_center =</span> <span class="fu">fwithin</span>(x, <span class="at">na.rm =</span> <span class="cn">FALSE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">fsummarise</span>(</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">slope =</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>       <span class="fu">fsum</span>(x_center, <span class="fu">fwithin</span>(y, <span class="at">na.rm =</span> <span class="cn">FALSE</span>), <span class="at">na.rm =</span> <span class="cn">FALSE</span>) <span class="sc">%/=%</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>       <span class="fu">fsum</span>(x_center, <span class="at">na.rm =</span> <span class="cn">FALSE</span>)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>   )</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(slope.clp<span class="fl">.3</span>[[<span class="st">&#39;slope&#39;</span>]], <span class="fu">unname</span>(slope.clp<span class="fl">.2</span>))</span></code></pre></div>
<pre><code>## [1] &quot;Mean absolute difference: Inf&quot;</code></pre>
<p>Ed: don’t recall why this isn’t working correctly now.</p>
</div>
</div>
<div id="group-sum" class="section level2">
<h2>Group Sum</h2>
<div id="r2c-baseline-1" class="section level3">
<h3>r2c baseline</h3>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(r2c)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>g.r2c <span class="ot">&lt;-</span> <span class="fu">process_groups</span>(g, <span class="at">sorted=</span><span class="cn">TRUE</span>)  <span class="co"># pre-group</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>r2c_sum <span class="ot">&lt;-</span> <span class="fu">r2cq</span>(<span class="fu">sum</span>(x))</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(sum.r2c <span class="ot">&lt;-</span> <span class="fu">group_exec</span>(r2c_sum, g.r2c, x))</span></code></pre></div>
<pre><code>##    user  system elapsed 
##    0.02    0.00    0.02</code></pre>
</div>
<div id="base-r-and-fastr-1" class="section level3">
<h3>Base R and FastR</h3>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(sum.base <span class="ot">&lt;-</span> <span class="fu">vapply</span>(x.split, sum, <span class="dv">0</span>))</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.214   0.004   0.218</code></pre>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(sum.r2c, sum.base)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p><code>{FastR}</code> uses the same code, but needs to be run under
the <code>{FastR}</code> implementation of R. Times for
<code>{FastR}</code> not reported.}</p>
</div>
<div id="data.table-1" class="section level3">
<h3>data.table</h3>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table); <span class="fu">setDTthreads</span>(<span class="dv">1</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">data.table</span>(x, g)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(dt, g)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(sum.dt <span class="ot">&lt;-</span> dt[, <span class="fu">sum</span>(x), <span class="at">keyby=</span>g][[<span class="st">&#39;V1&#39;</span>]])</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.115   0.007   0.122</code></pre>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(sum.dt, <span class="fu">unname</span>(sum.base))</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(sum.dt, <span class="fu">unname</span>(sum.base))</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
</div>
<div id="collapse-1" class="section level3">
<h3>collapse</h3>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(collapse)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>g.clp <span class="ot">&lt;-</span> <span class="fu">GRP</span>(g)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(sum.clp <span class="ot">&lt;-</span> <span class="fu">fsum</span>(x, g.clp, <span class="at">na.rm=</span><span class="cn">FALSE</span>))</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.032   0.000   0.032</code></pre>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(sum.clp, sum.base)</span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(sum.clp, sum.base)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
</div>
</div>
<div id="bigger-groups" class="section level2">
<h2>Bigger Groups</h2>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>gn <span class="ot">&lt;-</span> <span class="fl">1e3</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>ng <span class="ot">&lt;-</span> n<span class="sc">/</span>gn</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(<span class="fu">sample</span>(<span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="fu">rep</span>(<span class="cn">FALSE</span>, gn <span class="sc">-</span> <span class="dv">1</span>)), n, <span class="at">replace=</span><span class="cn">TRUE</span>))</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>x.split <span class="ot">&lt;-</span> <span class="fu">split</span>(x, g)</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>y.split <span class="ot">&lt;-</span> <span class="fu">split</span>(y, g)    <span class="co"># for later</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>g.r2c <span class="ot">&lt;-</span> <span class="fu">process_groups</span>(g, <span class="at">sorted=</span><span class="cn">TRUE</span>)</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>g.clp <span class="ot">&lt;-</span> <span class="fu">GRP</span>(g)</span></code></pre></div>
<p>And rerun the same code from before:</p>
<pre><code>system.time(slope.r2c &lt;- group_exec(r2c_slope, g.r2c, list(x, y)))
system.time(slope.base &lt;- mapply(slope, x.split, y.split))
dt &lt;- data.table(x, y, g)
setkey(dt, g)
mean &lt;- mean1  # so name change alone doesn&#39;t break Gforce
system.time(
  slope.dt &lt;- dt[,
    sum((x - mean(x)) * (y - mean(y))) / sum((x - mean(x)) ^ 2), keyby=g
  ][[&quot;V1&quot;]]
)
rm(mean)
fmean2 &lt;- function(x, cg) fmean(x, cg, na.rm=FALSE, TRA=&quot;replace_fill&quot;)
system.time(
  slope.clp &lt;-
    fsum((x - fmean2(x, g.clp)) * (y - fmean2(y, g.clp)), g.clp, na.rm=FALSE) /
    fsum((x - fmean2(x, g.clp))^2, g.clp, na.rm=FALSE)
)</code></pre>
<p>In this case there are fewer iterations so <code>{r2c}</code>’s
advantage is less pronounced, but still there.</p>
</div>
</div>
<div id="window-benchmarks" class="section level1">
<h1>Window Benchmarks</h1>
<div id="window-data" class="section level2">
<h2>Window Data</h2>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fl">1e6</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>w1 <span class="ot">&lt;-</span> w <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">runif</span>(n) <span class="sc">*</span> <span class="fu">runif</span>(n)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">runif</span>(n) <span class="sc">*</span> <span class="fu">runif</span>(n)</span></code></pre></div>
</div>
<div id="window-slope" class="section level2">
<h2>Window Slope</h2>
<div id="baselines" class="section level3">
<h3>Baselines</h3>
<p>We need a left and right aligned version because different
alternatives use different alignments (and some are not adjustable).
Here we use <code>mean</code> instead of <code>mean1</code> since we’re
not comparing against <code>collapse</code>.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>r2c_slope <span class="ot">&lt;-</span> <span class="fu">r2cq</span>(</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>((x <span class="sc">-</span> <span class="fu">mean</span>(x)) <span class="sc">*</span> (y <span class="sc">-</span> <span class="fu">mean</span>(y))) <span class="sc">/</span> <span class="fu">sum</span>((x <span class="sc">-</span> <span class="fu">mean</span>(x))<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>slope <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y)</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>((x <span class="sc">-</span> <span class="fu">mean</span>(x)) <span class="sc">*</span> (y <span class="sc">-</span> <span class="fu">mean</span>(y))) <span class="sc">/</span> <span class="fu">sum</span>((x <span class="sc">-</span> <span class="fu">mean</span>(x))<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>  slope.r2c <span class="ot">&lt;-</span> <span class="fu">rolli_exec</span>(r2c_slope, <span class="fu">list</span>(x, y), <span class="at">n=</span>w, <span class="at">align=</span><span class="st">&#39;left&#39;</span>)</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.643   0.002   0.644</code></pre>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  slope.r.r2c <span class="ot">&lt;-</span> <span class="fu">rolli_exec</span>(r2c_slope, <span class="fu">list</span>(x, y), <span class="at">n=</span>w, <span class="at">align=</span><span class="st">&#39;right&#39;</span>)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.642   0.001   0.643</code></pre>
</div>
<div id="base-and-fastr" class="section level3">
<h3>Base and FastR</h3>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  slope.base <span class="ot">&lt;-</span> <span class="fu">vapply</span>(</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq</span>(<span class="dv">1</span>, n <span class="sc">-</span> w1),</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(i) { i.n <span class="ot">&lt;-</span> i<span class="sc">:</span>(i <span class="sc">+</span> w1); <span class="fu">slope</span>(x[i.n], y[i.n]) },</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">numeric</span>(<span class="dv">1</span>)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   7.670   0.449   8.119</code></pre>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(slope.base, slope.r2c[<span class="sc">!</span><span class="fu">is.na</span>(slope.r2c)])</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p><code>{FastR}</code> uses the same code, but needs to be run under
the <code>{FastR}</code> implementation of R. Times for
<code>{FastR}</code>:</p>
<pre><code>c(11.08, 6.292, 4.601, 5.259, 4.641, 3.921, 4.255, 4.637, 4.889,
  4.661, 4.558)</code></pre>
</div>
<div id="roll" class="section level3">
<h3>Roll</h3>
<p>Coincidentally <code>{roll}</code> happens to implement an on-line
version of <code>lm</code>. We time it out of curiosity, but this is
still a special case implementation.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(roll)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>RcppParallel<span class="sc">::</span><span class="fu">setThreadOptions</span>(<span class="at">numThreads=</span><span class="dv">1</span>)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(slope.roll <span class="ot">&lt;-</span> <span class="fu">roll_lm</span>(x, y, <span class="at">width=</span>w))</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.291   0.024   0.315</code></pre>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(slope.roll<span class="sc">$</span>coefficients[,<span class="dv">2</span>], slope.r.r2c)</span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(slope.roll<span class="sc">$</span>coefficients[,<span class="dv">2</span>], slope.r.r2c)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
</div>
<div id="data.table-2" class="section level3">
<h3>data.table</h3>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  slope.dt <span class="ot">&lt;-</span> <span class="fu">frollapply</span>(<span class="fu">seq_along</span>(x), w, \(i) <span class="fu">slope</span>(x[i], y[i]))</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   7.799   0.486   8.284</code></pre>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(slope.dt, slope.r2c)</span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
</div>
<div id="zoo" class="section level3">
<h3>Zoo</h3>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(<span class="at">reps=</span><span class="dv">3</span>,</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  slope.zoo <span class="ot">&lt;-</span> zoo<span class="sc">::</span><span class="fu">rollapply</span>(</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq_along</span>(x), w, \(i) <span class="fu">slope</span>(x[i], y[i]), <span class="at">align=</span><span class="st">&#39;left&#39;</span>, <span class="at">fill=</span><span class="cn">NA</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>##    user  system elapsed 
##  12.601   0.722  13.454</code></pre>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(slope.zoo, slope.r2c)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
</div>
<div id="slider" class="section level3">
<h3>Slider</h3>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  slope.slider <span class="ot">&lt;-</span> slider<span class="sc">::</span><span class="fu">slide_dbl</span>(</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq_along</span>(x), \(i) <span class="fu">slope</span>(x[i], y[i]), <span class="at">.after=</span>w<span class="dv">-1</span>, <span class="at">.complete=</span><span class="cn">TRUE</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   7.777   0.489   8.268</code></pre>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(slope.slider, slope.r2c)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
</div>
</div>
<div id="window-sum" class="section level2">
<h2>Window Sum</h2>
<div id="r2c-baseline-2" class="section level3">
<h3>r2c Baseline</h3>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>r2c_sum <span class="ot">&lt;-</span> <span class="fu">r2cq</span>(<span class="fu">sum</span>(x))</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(sum.r2c <span class="ot">&lt;-</span> <span class="fu">rolli_exec</span>(r2c_sum, x, w, <span class="at">align=</span><span class="st">&#39;left&#39;</span>))</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.036   0.000   0.036</code></pre>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(sumr.r2c <span class="ot">&lt;-</span> <span class="fu">rolli_exec</span>(r2c_sum, x, w, <span class="at">align=</span><span class="st">&#39;right&#39;</span>))</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.035   0.000   0.036</code></pre>
</div>
<div id="base-and-fastr-1" class="section level3">
<h3>Base and FastR</h3>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(sum.base <span class="ot">&lt;-</span> <span class="fu">filter</span>(x, <span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">100</span>), <span class="at">sides=</span><span class="dv">1</span>))</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.123   0.000   0.123</code></pre>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(<span class="fu">c</span>(sum.base), sumr.r2c)</span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(<span class="fu">c</span>(sum.base), sumr.r2c)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>  sum2.base <span class="ot">&lt;-</span> <span class="fu">vapply</span>(</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq</span>(<span class="dv">1</span>, n <span class="sc">-</span> w1),</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(i) <span class="fu">sum</span>(x[i<span class="sc">:</span>(i <span class="sc">+</span> w1)]),</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">numeric</span>(<span class="dv">1</span>)</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   1.090   0.125   1.215</code></pre>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(sum2.base, sum.r2c[<span class="sc">!</span><span class="fu">is.na</span>(sum.r2c)])</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p><code>{FastR}</code> uses the same code, but needs to be run under
the <code>{FastR}</code> implementation of R. Times for
<code>{FastR}</code>:</p>
<pre><code>c(1.868,2.258, 1.924, 1.639, 1.377, 1.491,1.378, 1.360, 1.379,
  1.353, 1.281)</code></pre>
</div>
<div id="roll-1" class="section level3">
<h3>Roll</h3>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(sum.roll <span class="ot">&lt;-</span> roll<span class="sc">::</span><span class="fu">roll_sum</span>(x, w))</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.004   0.000   0.004</code></pre>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(sum.roll, sumr.r2c)</span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(sum.roll, sumr.r2c)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
</div>
<div id="zoo-1" class="section level3">
<h3>Zoo</h3>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(sum.zoo <span class="ot">&lt;-</span> zoo<span class="sc">::</span><span class="fu">rollsum</span>(x, w, <span class="at">fill=</span><span class="cn">NA</span>, <span class="at">align=</span><span class="st">&#39;left&#39;</span>))</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.086   0.008   0.094</code></pre>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(sum.zoo, sum.r2c)</span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(sum.zoo, sum.r2c)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
</div>
<div id="data.table-3" class="section level3">
<h3>data.table</h3>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(sum.dt <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">frollsum</span>(x, w, <span class="at">fill=</span><span class="cn">NA</span>, <span class="at">align=</span><span class="st">&#39;left&#39;</span>))</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.002   0.000   0.002</code></pre>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(sum.dt, sum.r2c)</span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(sum.dt, sum.r2c)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>  sum.e.dt <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">frollsum</span>(x, w, <span class="at">fill=</span><span class="cn">NA</span>, <span class="at">algo=</span><span class="st">&#39;exact&#39;</span>, <span class="at">align=</span><span class="st">&#39;left&#39;</span>)</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.054   0.000   0.054</code></pre>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(sum.e.dt, sum.r2c)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
</div>
<div id="rcpproll" class="section level3">
<h3>RcppRoll</h3>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(sum.rcpp <span class="ot">&lt;-</span> RcppRoll<span class="sc">::</span><span class="fu">roll_suml</span>(x, w, <span class="at">fill=</span><span class="cn">NA</span>))</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.054   0.000   0.058</code></pre>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(sum.dt, sum.r2c)</span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(sum.dt, sum.r2c)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
</div>
<div id="slider-1" class="section level3">
<h3>Slider</h3>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>  sum.slide <span class="ot">&lt;-</span> slider<span class="sc">::</span><span class="fu">slide_sum</span>(x, <span class="at">before=</span><span class="dv">0</span>, <span class="at">after=</span>w <span class="sc">-</span> <span class="dv">1</span>, <span class="at">complete=</span><span class="cn">TRUE</span>)</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.016   0.000   0.016</code></pre>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(sum.slide, sum.r2c)</span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(sum.slide, sum.r2c)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
</div>
</div>
</div>
<div id="session-info" class="section level1">
<h1>Session Info</h1>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code></pre></div>
<pre><code>## R version 4.2.2 (2022-10-31)
## Platform: aarch64-apple-darwin20 (64-bit)
## Running under: macOS Ventura 13.1
## 
## Matrix products: default
## BLAS:   /Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/lib/libRblas.0.dylib
## LAPACK: /Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/lib/libRlapack.dylib
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] roll_1.1.6        data.table_1.14.6 collapse_1.8.9    r2c_0.0.1.9000   
## [5] unitizer_1.4.18   vetr_0.2.14.9000 
## 
## loaded via a namespace (and not attached):
##  [1] Rcpp_1.0.9         knitr_1.41         magrittr_2.0.3     RcppRoll_0.3.0    
##  [5] lattice_0.20-45    R6_2.5.1           rlang_1.0.6        fastmap_1.1.0     
##  [9] stringr_1.5.0      tools_4.2.2        grid_4.2.2         parallel_4.2.2    
## [13] xfun_0.36          cli_3.5.0          slider_0.3.0       jquerylib_0.1.4   
## [17] htmltools_0.5.4    RcppParallel_5.1.5 yaml_2.3.6         digest_0.6.31     
## [21] lifecycle_1.0.3    crayon_1.5.2       sass_0.4.4         vctrs_0.5.1       
## [25] glue_1.6.2         cachem_1.0.6       evaluate_0.19      rmarkdown_2.19    
## [29] warp_0.2.0         stringi_1.7.8      compiler_4.2.2     bslib_0.4.2       
## [33] diffobj_0.3.5      jsonlite_1.8.4     zoo_1.8-11</code></pre>
</div>
<div class="footnotes footnotes-end-of-document">
<hr />
<ol>
<li id="fn1"><p>Pre-grouping in this case means primarily computing
group-offsets in data already sorted by group. Depending on the data,
sorting and grouping can be a significant part of the computational
cost, although it is similar for all all implementations tested here.
<code>{r2c}</code>, <code>{data.table}</code>, <code>{collapse}</code>
all use radix sort, although <code>{collapse}</code> also has a
hash-based grouping algorithm that is particularly effective for integer
groups in which the grouped result fits in CPU cache. Benchmarking the
grouping is out of scope of this document for the time being, but it is
an important part of group statistic computation.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
